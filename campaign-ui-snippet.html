<!-- ================================ -->
<!-- CAMPAIGN SELECTOR UI SNIPPET -->
<!-- Add this to index.html header -->
<!-- ================================ -->

<!-- Add to header-controls section (after character select) -->
<div class="campaign-controls">
  <select id="campaignSelect" class="campaign-select">
    <option value="">Select Campaign...</option>
  </select>
  <button id="createCampaignBtn" class="btn-create-campaign">+ New Campaign</button>
  <button id="joinCampaignBtn" class="btn-join-campaign">Join Campaign</button>
</div>

<!-- Add modal for creating campaign -->
<div id="createCampaignModal" class="modal" style="display: none;">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h2>Create New Campaign</h2>
    <form id="createCampaignForm">
      <label for="campaignName">Campaign Name:</label>
      <input type="text" id="campaignName" required placeholder="Pride City Rising">

      <label for="campaignDesc">Description:</label>
      <textarea id="campaignDesc" rows="3" placeholder="A fight for equality in a divided city..."></textarea>

      <button type="submit" class="btn-submit">Create Campaign</button>
    </form>
    <div id="campaignIdDisplay" style="display: none;">
      <h3>Campaign Created! ðŸŽ‰</h3>
      <p>Campaign ID (share with players):</p>
      <input type="text" id="campaignIdCopy" readonly>
      <button id="copyCampaignId" class="btn-copy">Copy ID</button>
    </div>
  </div>
</div>

<!-- Add modal for joining campaign -->
<div id="joinCampaignModal" class="modal" style="display: none;">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h2>Join Campaign</h2>
    <form id="joinCampaignForm">
      <label for="joinCampaignId">Campaign ID:</label>
      <input type="text" id="joinCampaignId" required placeholder="Paste campaign ID here">

      <label for="joinCharacterName">Your Character:</label>
      <input type="text" id="joinCharacterName" required placeholder="Character Name">

      <button type="submit" class="btn-submit">Join Campaign</button>
    </form>
  </div>
</div>

<!-- Add to CSS (or styles-player.css) -->
<style>
.campaign-controls {
  display: flex;
  gap: 10px;
  align-items: center;
  margin: 10px 0;
}

.campaign-select {
  padding: 8px 12px;
  font-size: 14px;
  border: 2px solid #9C27B0;
  border-radius: 8px;
  background: white;
  color: #333;
  min-width: 200px;
}

.btn-create-campaign,
.btn-join-campaign {
  padding: 8px 16px;
  background: #9C27B0;
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-weight: bold;
}

.btn-create-campaign:hover,
.btn-join-campaign:hover {
  background: #7B1FA2;
}

.modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  overflow: auto;
  background-color: rgba(0,0,0,0.4);
}

.modal-content {
  background-color: #fefefe;
  margin: 10% auto;
  padding: 20px;
  border: 1px solid #888;
  border-radius: 12px;
  width: 80%;
  max-width: 500px;
}

.close {
  color: #aaa;
  float: right;
  font-size: 28px;
  font-weight: bold;
  cursor: pointer;
}

.close:hover,
.close:focus {
  color: black;
}

.modal form label {
  display: block;
  margin-top: 15px;
  font-weight: bold;
}

.modal form input[type="text"],
.modal form textarea {
  width: 100%;
  padding: 8px;
  margin-top: 5px;
  border: 2px solid #ddd;
  border-radius: 4px;
  font-size: 14px;
}

.btn-submit {
  margin-top: 20px;
  padding: 10px 20px;
  background: #4CAF50;
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-size: 16px;
  font-weight: bold;
}

.btn-submit:hover {
  background: #45a049;
}

.btn-copy {
  padding: 8px 16px;
  background: #2196F3;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  margin-top: 10px;
}

#campaignIdCopy {
  font-family: monospace;
  background: #f0f0f0;
  padding: 10px;
  margin-top: 10px;
}
</style>

<!-- Add JavaScript (to player-app.js or separate file) -->
<script type="module">
import {
  createCampaign,
  joinCampaign,
  listUserCampaigns,
  loadCampaign,
  loadCharacterState,
  saveCharacterState,
  listenToCurrentScene
} from './campaign-manager.js';

// Setup campaign UI when DOM loads
document.addEventListener("DOMContentLoaded", async () => {

  // Load campaigns into selector
  async function refreshCampaigns() {
    const select = document.getElementById("campaignSelect");
    const campaigns = await listUserCampaigns();

    select.innerHTML = '<option value="">Select Campaign...</option>';
    campaigns.forEach(c => {
      const option = document.createElement("option");
      option.value = c.id;
      option.textContent = `${c.name} (${c.role === 'mc' ? 'MC' : 'Player'})`;
      select.appendChild(option);
    });
  }

  await refreshCampaigns();

  // Campaign selection
  document.getElementById("campaignSelect").addEventListener("change", async (e) => {
    const campaignId = e.target.value;
    if (!campaignId) return;

    console.log("Loading campaign:", campaignId);
    const campaign = await loadCampaign(campaignId);

    if (campaign) {
      alert(`Campaign loaded: ${campaign.metadata.name}`);

      // Load character state if character is active
      if (window.activeCharacter) {
        const state = await loadCharacterState(window.activeCharacter);
        if (state) {
          Object.assign(window.characterLibrary[window.activeCharacter], state);
          window.renderCharacterSheet(window.characterLibrary[window.activeCharacter]);
        }
      }

      // Listen to current scene updates
      listenToCurrentScene(campaignId, (scene) => {
        console.log("Current scene:", scene.name);
        // Update UI with scene info
        const sceneInfo = document.getElementById("sceneInfo");
        if (sceneInfo) sceneInfo.textContent = scene.name;
      });
    }
  });

  // Create campaign button
  const createBtn = document.getElementById("createCampaignBtn");
  const createModal = document.getElementById("createCampaignModal");

  createBtn.addEventListener("click", () => {
    createModal.style.display = "block";
  });

  // Create campaign form
  document.getElementById("createCampaignForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    const name = document.getElementById("campaignName").value;
    const description = document.getElementById("campaignDesc").value;

    const campaignId = await createCampaign({ name, description });

    if (campaignId) {
      // Show campaign ID to copy
      document.getElementById("createCampaignForm").style.display = "none";
      document.getElementById("campaignIdDisplay").style.display = "block";
      document.getElementById("campaignIdCopy").value = campaignId;

      await refreshCampaigns();
    }
  });

  // Copy campaign ID
  document.getElementById("copyCampaignId").addEventListener("click", () => {
    const input = document.getElementById("campaignIdCopy");
    input.select();
    document.execCommand("copy");
    alert("Campaign ID copied!");
  });

  // Join campaign button
  const joinBtn = document.getElementById("joinCampaignBtn");
  const joinModal = document.getElementById("joinCampaignModal");

  joinBtn.addEventListener("click", () => {
    joinModal.style.display = "block";
  });

  // Join campaign form
  document.getElementById("joinCampaignForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    const campaignId = document.getElementById("joinCampaignId").value.trim();
    const characterName = document.getElementById("joinCharacterName").value.trim();

    const success = await joinCampaign(campaignId, characterName);

    if (success) {
      alert(`Joined campaign as ${characterName}!`);
      joinModal.style.display = "none";
      await refreshCampaigns();

      // Auto-select the campaign
      document.getElementById("campaignSelect").value = campaignId;
      document.getElementById("campaignSelect").dispatchEvent(new Event('change'));
    } else {
      alert("Failed to join campaign. Check the Campaign ID and try again.");
    }
  });

  // Close modals
  document.querySelectorAll(".close").forEach(closeBtn => {
    closeBtn.addEventListener("click", () => {
      createModal.style.display = "none";
      joinModal.style.display = "none";

      // Reset forms
      document.getElementById("createCampaignForm").reset();
      document.getElementById("createCampaignForm").style.display = "block";
      document.getElementById("campaignIdDisplay").style.display = "none";
      document.getElementById("joinCampaignForm").reset();
    });
  });

  // Click outside to close
  window.addEventListener("click", (event) => {
    if (event.target == createModal) {
      createModal.style.display = "none";
    }
    if (event.target == joinModal) {
      joinModal.style.display = "none";
    }
  });

  console.log("âœ… Campaign UI initialized");
});

// Auto-save character state to campaign when character changes
// Add this to your existing saveActiveCharacterToCloud function
window.addEventListener('character-saved', async () => {
  if (window.activeCampaignId && window.activeCharacter) {
    const char = window.characterLibrary[window.activeCharacter];
    await saveCharacterState(char);
  }
});
</script>
